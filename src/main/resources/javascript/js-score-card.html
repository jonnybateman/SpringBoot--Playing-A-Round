<script  th:inline="javascript">

var oldHoleScore;

// Get the document's root element so that css variables can be utilized.
var root = document.documentElement;
var styles = getComputedStyle(root);

// Get the player id from model attribute.
var playerId = /*[[${playerDetails.playerId}]]*/ {};

// Get the team id from model attribute and set it as a cookie.
var teamId = /*[[${playerDetails.teamId}]]*/ {};
setSessionStorageValue(getNameTeamId(), teamId);

// Get the game id from model attribute and set it as a cookie.
var gameId = /*[[${scorecardData[0].gameId}]]*/ {};
setSessionStorageValue(getNameGameId(), gameId);

// Set the cookie for the team name.
var teamName = /*[[${playerDetails.teamName}]]*/ {};
setSessionStorageValue(getNameTeam(), teamName);

// Set the cookie for drive distance if not already set.
var driveDistance = getSessionStorageValue(getNameDriveDistance());
if (driveDistance == null || driveDistance == "") {
  setSessionStorageValue(getNameDriveDistance(), 0);
}

// Get the player scores from the model attribute.
var scores = /*[[${scores}]]*/ {};

// Calculate the Out and In score totals for the hole scores and assign to the
// applicable input fields in the web view.
calculateOutInTotals();

// Set margin height for first element below nav bar.
var navHeight = document.querySelector("nav").offsetHeight;
var divScorecardCourse = document.getElementById("divScorecardCourse");
divScorecardCourse.style.cssText = "margin-top: " + (navHeight + 50) + "px;";

// Set the cookies for default hole on page load if not already set.
if (getSessionStorageValue(getNameHoleNo()) == null) {
  setSessionStorageValue(getNameHoleNo(), 1);
  setSessionStorageValue(getNameHoleId(), document.getElementById("hole1").dataset.holeId);
                // element attribute data-hole-id  => holeId
}

// Highlight applicable hole as the current hole, deduced from session storage value.
document.getElementById("hole" + getSessionStorageValue(getNameHoleNo())).style.backgroundColor =
    styles.getPropertyValue('--table-body-bg-color');
document.getElementById("inputHole" + getSessionStorageValue(getNameHoleNo())).readOnly = false;

// Setup an event listener for when the document content has been loaded. It will
// create a GeoLocation WatchPosition object to return the device's current position
// when a change in position has been detected.
var watchId = null;
var loc_lat = null;
var loc_long = null;
const geolocationOptions = {
  enableHighAccuracy: true,
  maximumAge: 0
};
document.addEventListener("DOMContentLoaded", function() {
    if (navigator.geolocation) {
      console.log("WatchPosition activated");
      watchId = navigator.geolocation.watchPosition(
                    onGeoSuccessCallback, showError, geolocationOptions);
    } else {
      alert("Sorry, GPS location not available.")
    }
  }
);

// If a Geolocation WatchPosition object has been created, deactivate it on page unload.
window.addEventListener("beforeunload", function() {
    if (watchId != null) {
      console.log("WatchPosition deactivated");
      navigator.geolocation.clearWatch(watchId);
    }
  }
);

// Setup event listeners for 'next' and 'previous' hole buttons.
var prevHoleButton = document.getElementById("prevHole");
prevHoleButton.addEventListener("click", function() {
  // Highlight the new current hole and set value of hole number cookie accordingly.
  let cHoleNo = parseInt(getSessionStorageValue(getNameHoleNo()));
  
  if (cHoleNo > 1) {
    let currHole = document.getElementById("hole" + (cHoleNo - 1));
    setSessionStorageValue(getNameHoleNo(), cHoleNo - 1);

    currHole.style.backgroundColor = styles.getPropertyValue('--table-body-bg-color');
    document.getElementById("hole" + cHoleNo).style.backgroundColor =
        styles.getPropertyValue('--table-header-bg-color');
    document.getElementById("inputHole" + (cHoleNo - 1)).readOnly = false;
    document.getElementById("inputHole" + (cHoleNo)).readOnly = true;
    document.getElementById("range").innerHTML = "- - - yards";

    // If we do not have pin location data for hole, query database to see if it is now available.
    if (currHole.dataset.locLat == null) {
      $.ajax({
        type: "GET",
        url: "[(@{/getPinLocationData})]",
        dataType: "json",
        data: { "holeId": currHole.dataset.holeId },
        success: function (result) {
          if (result.locLat != null) {
            currHole.dataset.locLat = result.locLat;
            currHole.dataset.locLong = result.locLong;
          }
        }
      });
    }
  }
});

var nextHoleButton = document.getElementById("nextHole");
nextHoleButton.addEventListener("click", function() {
  // Highlight the new current hole and set value of hole number cookie accordingly.
  let cHoleNo = parseInt(getSessionStorageValue(getNameHoleNo()));
  
  if (cHoleNo < 18) {
    let currHole = document.getElementById("hole" + (cHoleNo + 1));
    setSessionStorageValue(getNameHoleNo(), cHoleNo + 1);

    currHole.style.backgroundColor = styles.getPropertyValue('--table-body-bg-color');
    document.getElementById("hole" + cHoleNo).style.backgroundColor =
        styles.getPropertyValue('--table-header-bg-color');
    document.getElementById("inputHole" + (cHoleNo + 1)).readOnly = false;
    document.getElementById("inputHole" + (cHoleNo)).readOnly = true;
    document.getElementById("range").innerHTML = "- - - yards";

    // If we do not have pin location data for hole, query database to see if it is now available.
    if (currHole.dataset.locLat == null) {
      $.ajax({
        type: "GET",
        url: "[(@{/getPinLocationData})]",
        dataType: "json",
        data: { "holeId": currHole.dataset.holeId },
        success: function (result) {
          if (result.locLat != null) {
            currHole.dataset.locLat = result.locLat;
            currHole.dataset.locLong = result.locLong;
          }
        }
      });
    }
  }
});

// Create click handler for setPinLocation icon.
var setPinLocation = document.getElementById("setPinLocation");
setPinLocation.addEventListener("click", function () {
  if (confirm("Do you want to set pin location?")) {
    var hole = document.getElementById("hole" + getSessionStorageValue(getNameHoleNo()));
    // If hole has no location data for pin.
    if (hole.dataset.locLat == null) {
      // Get the current GPS coordinates.
      if (navigator.geolocation) {
        // Retrieve the current position of the device and pass the coordinates to the
        // app controller.
        $.ajax({
          type: "post",
          url: "[(@{/addLocationToHole})]",
          dataType: "json",
          data: {
            "holeId": hole.dataset.holeId,
            "lat": loc_lat,
            "lon": loc_long
          },
          success: function (result) {
            if (result == true) {
              alert("Pin location data saved.")
            } else {
              alert("Pin location data could not be saved.");
            }
          }
        });
      } else {
        alert("Sorry, geolocation not supported.");
      }
    }
  }
});

// Create click listener for measureDrive icon.
var measureDriveFlag = false;
var driveLocLat;
var driveLocLong;
var measureDrive = document.getElementById("measureDrive");
measureDrive.addEventListener("click", function() {
  if (!measureDriveFlag) {
    if (confirm("Do you want to measure your drive?")) {
      // Get the GPS location for drive position.
      if (navigator.geolocation) {
        driveLocLat = loc_lat;
        driveLocLong = loc_long;
        measureDrive.classList.remove("fa-golf-ball-tee");
        measureDrive.classList.add("fa-arrows-to-circle");
        measureDriveFlag = true;
      } else {
        document.getElementById("range").innerHTML = "Sorry, geolocation not supported";
      }
    }
  } else {
    // Get the GPS location for where the ball ended up and calculate distance.
    if (navigator.geolocation) {
      // Calculate drive distance
      let distance = Math.round(calculateYardage(driveLocLat,
        driveLocLong,
        loc_lat,
        loc_long));

      // Display the distance driven on scorecard.
      document.getElementById("range").innerHTML = "Drive: " + distance + " yards";

      if (distance > getSessionStorageValue(getNameDriveDistance())) {
        // Post the distance to the database. If the distance is longer than the
        // current longest drive for the player then the distance value will be
        // updated in the database.
        $.ajax({
          type: "post",
          url: "[(@{/setLongestDrive})]",
          dataType: "json",
          data: {
            "playerId": playerId,
            "distance": distance
          },
          success: function (result) {
            setSessionStorageValue(getNameDriveDistance(), distance);
          }
        });
      }
      measureDrive.classList.remove("fa-arrows-to-circle");
      measureDrive.classList.add("fa-golf-ball-tee");
      measureDriveFlag = false;
    } else {
      document.getElementById("range").innerHTML = "Sorry, geolocation not supported";
    }
  }
});

/*
 * If pin location data is available display the distance to pin in yards.
 */
var rangeToPin = document.getElementById("rangeToPin");
rangeToPin.addEventListener("click", function() {
  let pinLocLat = document.getElementById("hole" + getSessionStorageValue(getNameHoleNo())).dataset.locLat;
  let pinLocLong = document.getElementById("hole" + getSessionStorageValue(getNameHoleNo())).dataset.locLong;

  // Calculate the the distance to pin if we have pin location data.
  if (pinLocLat != null) {
    // If GeoLocation is available calculate distance to the pin.
    if (navigator.geolocation) {
      let yardage = calculateYardage(loc_lat, loc_long, Number(pinLocLat), Number(pinLocLong));

      if (yardage != null) {
        document.getElementById("range").innerHTML = Math.round(yardage) + " yards to pin";
      } else {
        document.getElementById("range").innerHTML = "Range data not available";
      }
    } else {
      document.getElementById("range").innerHTML = "Sorry, geolocation not supported";
    }
  } else {
    document.getElementById("range").innerHTML = "Range data not available";
  }
});

/*
 * Callback method when geolocation.watchPosition has successfully detected a change
 * in the device's location.
 */
function onGeoSuccessCallback(position) {
  loc_lat = position.coords.latitude;
  loc_long = position.coords.longitude;
}

/*
 * Callback method to show any errors raised when attempting to use geo location.
 */
 function showError(error) {
  switch(error.code) {
    case error.PERMISSION_DENIED:
      alert("User denied the request for Geolocation.");
      break;
    case error.POSITION_UNAVAILABLE:
      alert("Location information is unavailable.");
      break;
    case error.TIMEOUT:
      alert("The request to get user location timed out.");
      break;
    case error.UNKNOWN_ERROR:
      alert("An unknown error occurred.");
      break;
  }
  navigator.geolocation.clearWatch(watchId);
}

/*
 * Calculate the distance in yards between two sets of GPS coordinates.
 */
function calculateYardage(lat1, long1, lat2, long2) {
  if ((lat1 == lat2) && (long1 == long2)) {
    return 0;
  } else {
    var radLat1 = Math.PI * lat1/180;
    var radLat2 = Math.PI * lat2/180;
    var theta = long1 - long2;
    var radTheta = Math.PI * theta/180; 
    var dist = Math.sin(radLat1) * Math.sin(radLat2) + Math.cos(radLat1) * Math.cos(radLat2) * Math.cos(radTheta);

    if (dist > 1) {
      dist = 1;
    }

    dist = Math.acos(dist);
    dist = dist * 180/Math.PI;
    dist = dist * 60 * 1.1515;
    var yardage = dist * 1760;
    console.log("Yardage:" + yardage);
    return yardage;
  }

  return null;
}

/*
 * Calculate the Out and In score totals for the player.
 */
function calculateOutInTotals() {

  let scoreOut = 0;
  let scoreIn = 0;

  for (let i=1; i<=9; i++) {
    let score = Number(eval("document.getElementById('inputHole" + i + "').value"));
    scoreOut += (score === null ? 0 : score);
  }
  document.getElementById('inputOut').value = scoreOut;

  for (let i=10; i<=18; i++) {
    let score = Number(eval("document.getElementById('inputHole" + i + "').value"));
    scoreIn += (score === null ? 0 : score);
  }
  document.getElementById('inputIn').value = scoreIn;
}

/*
 * When a hole input has focus set the variable currentHoleScore to the value of the
 * input. The variable can then be compared to the new value entered during the
 * onblur event. If the values are the same no need to send to the app controller.
 */
function holeInputOnFocusEvent(holeNo) {

  // Get the score set for the hole.
  let holeInput = document.getElementById("inputHole" + (holeNo));
  oldHoleScore = holeInput.value == '' ? 0 : holeInput.value;
}

/*
 * When a hole input element loses focus send the score to the app controller
 * so that it can be posted to the database.
 */
function holeInputOnBlurEvent(holeNo) {

  // Get the score set for the hole.
  let newHoleScore = document.getElementById("inputHole" + (holeNo)).value;

  if (newHoleScore != "" && newHoleScore > 0 && newHoleScore != oldHoleScore) {
    console.log("Hole value has changed!")
    // Calculate new Out and In totals
    calculateOutInTotals();

    // Send hole score to the app controller.
    $.ajax({
        type: "POST",
        url: "[(@{/setHoleScore})]",
        dataType: "json",
        data: { "gameId": gameId,
                "teamId": teamId,
                "playerId": playerId,
                "holeId": holeNo,
                "score": newHoleScore
              },
        success: function(result) {}
    });
  }
}

</script>